<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Santana Check In — USERS + LOG + AUTOSIGNOUT</title>
  <style>
    :root{--bg:#f7f8fa;--card:#ffffff;--card2:#f2f5fa;--text:#1a1a1a;--muted:#6d7785;--ok:#28a745;--warn:#ffbf00;--bad:#dc3545;--line:#e0e4ec;--primary:#2f6fed}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--line);background:linear-gradient(180deg,#ffffff,#f2f4f8)}
    header h1{margin:0;font-size:16px;letter-spacing:.2px}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
    .tab{padding:10px 14px;border:1px solid var(--line);background:var(--card);border-radius:10px;cursor:pointer}
    .tab.active{outline:2px solid var(--primary)}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .card{grid-column:span 12;background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;box-shadow:0 1px 2px rgba(0,0,0,0.03)}
    @media(min-width:900px){.half{grid-column:span 6}}
    h2{margin:4px 0 10px 0;font-size:15px;color:#2b3a57}
    label{display:block;margin:10px 0 6px 0;color:#2b3a57}
    input[type="text"], input[type="password"], input[type="email"], select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:var(--card2);color:var(--text)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{appearance:none;border:1px solid var(--line);background:#eef2ff;color:#1d2a5b;padding:10px 14px;border-radius:10px;cursor:pointer}
    .btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
    .btn.ghost{background:transparent}
    .btn.bad{background:var(--bad);border-color:#d86868;color:#fff}
    .btn.warn{background:#ffd76a;border-color:#ffca3a}
    .btn.ok{background:#3bc37d;border-color:#34af70;color:#fff}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .tag{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;background:#eef2ff;border:1px solid var(--line);font-size:12px;color:#1d2a5b}
    .tag.ok{background:#e9f8ef;border-color:#cdeed9;color:#166b3b}
    .tag.warn{background:#fff5db;border-color:#ffe8a1;color:#7a5a00}
    .tag.bad{background:#ffe9ea;border-color:#ffd0d3;color:#8b1c27}
    table{width:100%;border-collapse:collapse;border-spacing:0}
    th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left;vertical-align:middle}
    th{font-weight:600;color:#2b3a57}
    tr:hover td{background:#f7f9ff}
    .muted{color:var(--muted)}
    .sep{height:1px;background:var(--line);margin:12px 0}
    .small{font-size:12px;color:#2b3a57}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:9999}
    .modal{background:#fff;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,0.12);padding:16px;min-width:320px;max-width:90vw}
    .modal h3{margin:0 0 10px 0}
    .right{margin-left:auto}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <header>
    <h1>Santana Check In</h1>
    <div class="row">
      <span id="userBadge" class="tag">Not signed in</span>
      <button class="btn" id="btnOpenAuth">Sign in</button>
      <button class="btn ghost" id="btnSignOut" style="display:none">Sign out</button>
      <button class="btn right" id="btnExport" title="Admin only">Export JSON</button>
      <button class="btn" id="btnImport" title="Admin only">Import JSON</button>
      <input type="file" id="fileImport" accept="application/json" style="display:none" />
      <button class="btn bad" id="btnWipe" title="Admin only">Wipe Data</button>
    </div>
  </header>

  <div class="wrap">
    <div class="tabs" id="tabs"></div>

    <main id="views">
      <section id="view-checkin" class="view">
        <div class="grid">
          <div class="card half">
            <h2>Front Desk — Check‑In</h2>
            <label>Patient Number</label>
            <input type="text" id="ciPatient" placeholder="e.g. PN123456" autocomplete="off" />
            <div class="row" style="margin-top:10px">
              <button class="btn primary" id="btnAddCheckin">Record Check‑In</button>
              <span class="small">Server timestamp.</span>
            </div>
            <div class="sep"></div>
            <div class="small">Last 5 check‑ins</div>
            <table id="tblCheckinRecent"></table>
          </div>

          <div class="card half">
            <h2>Doctor Room — Seen</h2>
            <label>Patient Number</label>
            <input type="text" id="dvPatient" placeholder="e.g. PN123456" autocomplete="off" />
            <label>Doctor (your name/ID)</label>
            <input type="text" id="dvDoctor" placeholder="e.g. Dr Lerato" autocomplete="off" />
            <div class="row" style="margin-top:10px">
              <button class="btn ok" id="btnAddDoctorVisit">Record Seen</button>
              <span class="small">Server timestamp.</span>
            </div>
            <div class="sep"></div>
            <div class="small">Last 5 doctor entries</div>
            <table id="tblDoctorRecent"></table>
          </div>
        </div>
      </section>

      <section id="view-recon" class="view" style="display:none">
        <div class="card">
          <h2>Reconciliation — Daily Audit</h2>
          <div class="row" style="gap:12px;margin-bottom:10px">
            <label>Date <input type="date" id="reconDate" /></label>
            <label>Max Window (hours)
              <select id="windowHrs">
                <option value="12">12</option>
                <option value="24" selected>24</option>
                <option value="48">48</option>
              </select>
            </label>
            <button class="btn" id="btnRefreshRecon">Refresh</button>
            <button class="btn" id="btnExportCSV">Export CSV</button>
          </div>
          <table id="tblRecon"></table>
        </div>

        <div class="grid" style="margin-top:12px">
          <div class="card half">
            <h2>Unmatched Doctor Entries <span class="tag bad" id="cntUnmatched">0</span></h2>
            <table id="tblUnmatched"></table>
          </div>
          <div class="card half">
            <h2>Unseen Check‑Ins <span class="tag warn" id="cntUnseen">0</span></h2>
            <table id="tblUnseen"></table>
          </div>
        </div>
      </section>

      <section id="view-admin" class="view" style="display:none">
        <div class="card">
          <h2>Admin — Users & Roles</h2>
          <div class="tools row" style="margin:8px 0 12px 0">
            <input type="text" id="userSearch" placeholder="Search email…" />
            <span class="tag" id="userCount">0 users</span>
            <button class="btn" id="btnRefreshUsers">Refresh</button>
          </div>
          <table id="tblUsers"></table>
          <div class="sep"></div>
          <div class="small">Users appear here after they’ve signed in once. Change roles using the dropdowns. Only admins can see this page.</div>
        </div>
      </section>

      <section id="view-log" class="view" style="display:none">
        <div class="card">
          <h2>Immutable Audit Log</h2>
          <table id="tblLog"></table>
        </div>
      </section>
    </main>
  </div>

  <div id="authOverlay" class="overlay" aria-modal="true" role="dialog">
    <div class="modal">
      <h3>Sign in / Sign up</h3>
      <label>Email</label>
      <input type="email" id="authEmail" autocomplete="off" autocapitalize="none" spellcheck="false" required />
      <label>Password</label>
      <input type="password" id="authPassword" autocomplete="new-password" autocapitalize="none" spellcheck="false" required />
      <div class="row" style="margin-top:10px">
  <button class="btn primary" id="btnDoSignIn">Sign in</button>
  <button class="btn" id="btnDoSignUp" type="button">Sign up</button>
  <button class="btn ghost" id="btnForgot" type="button">Forgot password?</button>
  <button class="btn ghost right" id="btnCloseAuth">Close</button>
</div>
      <div class="small muted">First user becomes <b>admin</b>.</div>
    </div>
  </div>

  <script>
    // ====== PASTE YOUR SUPABASE KEYS HERE ======
    const SUPABASE_URL = "https://eqgecbyrewtgvunsehnd.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVxZ2VjYnlyZXd0Z3Z1bnNlaG5kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzNjU3NzgsImV4cCI6MjA3NTk0MTc3OH0.KTlM8qjcTo4b7j_9TyDKigEX0f7Tdq9qYBGAym1xWwc";
    // ===========================================

    // Inactivity auto sign-out (10 minutes)
    const AUTO_SIGNOUT_MS = 10 * 60 * 1000;
    let inactivityTimer = null;
    function resetInactivityTimer() {
      if (inactivityTimer) clearTimeout(inactivityTimer);
      inactivityTimer = setTimeout(() => {
        if (!window.supabase) return;
        supabase.auth.signOut().finally(() => {
          window.APP_ROLE = null;
          clearAuthFields();
          alert("Signed out due to inactivity.");
          openAuth();
        });
      }, AUTO_SIGNOUT_MS);
    }
    ["click","mousemove","keydown","touchstart","scroll"].forEach(ev => {
      window.addEventListener(ev, resetInactivityTimer, { passive: true });
    });

    function waitForSupabase() {
      return new Promise((resolve, reject) => {
        let tries=0, max=50; (function check(){
          if (window.supabase && window.supabase.createClient) return resolve();
          if (++tries > max) return reject(new Error("Supabase library failed to load"));
          setTimeout(check, 100);
        })();
      });
    }

    const TABS = [
      { id: "view-checkin", label: "Capture", roles: ["frontdesk", "doctor", "admin"] },
      { id: "view-recon",   label: "Reconciliation", roles: ["admin"] },
      { id: "view-admin",   label: "Users", roles: ["admin"] },
      { id: "view-log",     label: "Audit Log", roles: ["admin"] },
    ];
    function renderTabs(activeId, role) {
      const c = document.getElementById("tabs"); c.innerHTML = "";
      TABS.filter(t => t.roles.includes(role)).forEach(t => {
        const b = document.createElement("button");
        b.className = "tab" + (t.id === activeId ? " active" : "");
        b.textContent = t.label;
        b.onclick = () => showView(t.id, role);
        c.appendChild(b);
      });
    }
    function showView(id, role) {
      document.querySelectorAll(".view").forEach(v => v.style.display = "none");
      document.getElementById(id).style.display = "block";
      renderTabs(id, role);
      if (id === "view-recon") renderRecon();
      if (id === "view-log") renderLog();
      if (id === "view-admin") renderUsersList();
    }

    let supabase = null;
    function createClient() {
      const { createClient } = window.supabase;
      supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    }

    function dayRange(date) { const d0 = new Date(date); d0.setHours(0,0,0,0); const d1 = new Date(d0); d1.setDate(d1.getDate()+1); return [d0.toISOString(), d1.toISOString()]; }

    function renderTable(el, cols, data) {
      el.innerHTML = "";
      const thead = document.createElement("thead"); const trh = document.createElement("tr");
      cols.forEach(c => { const th = document.createElement("th"); th.textContent = c.label; trh.appendChild(th); });
      thead.appendChild(trh);
      const tb = document.createElement("tbody");
      data.forEach(row => {
        const tr = document.createElement("tr");
        cols.forEach(c => {
          const td = document.createElement("td");
          td.dataset.key = c.key;
          const v = row[c.key];
          if (c.render) {
            td.appendChild(c.render(row));
          } else if (c.key === "status") {
            const span = document.createElement("span");
            span.className = "tag " + (v === "MATCH" ? "ok" : (String(v).includes("UNSEEN") ? "warn" : "bad"));
            span.textContent = v; td.appendChild(span);
          } else if (["ci","dv","ts","created_at"].includes(c.key)) {
            td.textContent = v ? new Date(v).toLocaleString() : "";
            td.className = "muted";
          } else {
            td.textContent = (v ?? "");
          }
          tr.appendChild(td);
        });
        tb.appendChild(tr);
      });
      el.appendChild(thead); el.appendChild(tb);
    }

    async function dbInsert(table, row) {
      const { data, error } = await supabase.from(table).insert(row).select().single();
      if (error) { alert("DB error: " + error.message); return null; }
      return data;
    }
    async function dbRecent(table, limit=5) {
      const { data, error } = await supabase.from(table).select("*").order("ts", { ascending: false }).limit(limit);
      if (error) { alert("DB error: " + error.message); return []; }
      return data || [];
    }
    async function dbByDay(table, date) {
      const [start, end] = dayRange(date);
      const { data, error } = await supabase.from(table).select("*").gte("ts", start).lt("ts", end).order("ts");
      if (error) { alert("DB error: " + error.message); return []; }
      return data || [];
    }
    async function dbLog(action, meta) { await dbInsert("audit_log", { action, meta }); }

    async function renderRecent() {
      const ci = await dbRecent("check_ins", 5);
      const dv = await dbRecent("doctor_visits", 5);
      renderTable(document.getElementById("tblCheckinRecent"),
        [{key:"patient",label:"Patient #"}, {key:"ts",label:"Check‑In Time"}], ci);
      renderTable(document.getElementById("tblDoctorRecent"),
        [{key:"patient",label:"Patient #"}, {key:"doctor",label:"Doctor"}, {key:"ts",label:"Seen Time"}], dv);
    }

    function reconcileRows(cis, dvs, windowHours) {
      const byPnCI = new Map(); cis.forEach(r => byPnCI.set(r.patient, (byPnCI.get(r.patient)||[]).concat([r])));
      const byPnDV = new Map(); dvs.forEach(r => byPnDV.set(r.patient, (byPnDV.get(r.patient)||[]).concat([r])));
      const patients = new Set([...byPnCI.keys(), ...byPnDV.keys()]);
      const rows = [], unmatched = [], unseen = [];
      const winMs = windowHours * 3600 * 1000;
      for (const pn of patients) {
        const ciList = (byPnCI.get(pn)||[]).sort((a,b)=>a.ts.localeCompare(b.ts));
        const dvList = (byPnDV.get(pn)||[]).sort((a,b)=>a.ts.localeCompare(b.ts));
        const usedDV = new Set();
        for (const ci of ciList) {
          let matchedDV = null;
          for (const dv of dvList) {
            if (usedDV.has(dv.id)) continue;
            const dt = new Date(dv.ts) - new Date(ci.ts);
            if (dt >= 0 && dt <= winMs) { matchedDV = dv; break; }
          }
          if (matchedDV) {
            usedDV.add(matchedDV.id);
            rows.push({ patient: pn, ci: ci.ts, dv: matchedDV.ts, doctor: matchedDV.doctor||"", diffMin: Math.round((new Date(matchedDV.ts)-new Date(ci.ts))/60000), status: "MATCH" });
          } else {
            rows.push({ patient: pn, ci: ci.ts, dv: "", doctor: "", diffMin: "", status: "UNSEEN CHECK-IN" });
            unseen.push({ patient: pn, ci: ci.ts });
          }
        }
        for (const dv of dvList) {
          if (!usedDV.has(dv.id)) {
            rows.push({ patient: pn, ci: "", dv: dv.ts, doctor: dv.doctor||"", diffMin: "", status: "UNMATCHED DOCTOR ENTRY" });
            unmatched.push({ patient: pn, dv: dv.ts, doctor: dv.doctor||"" });
          }
        }
      }
      rows.sort((a,b)=> (a.status===b.status ? a.patient.localeCompare(b.patient) : (a.status > b.status ? 1 : -1)));
      return { rows, unmatched, unseen };
    }
    async function renderRecon() {
      const date = document.getElementById("reconDate").value ? new Date(document.getElementById("reconDate").value + "T00:00:00") : new Date();
      const win = parseInt(document.getElementById("windowHrs").value || "24", 10);
      const cis = await dbByDay("check_ins", date);
      const dvs = await dbByDay("doctor_visits", date);
      const { rows, unmatched, unseen } = reconcileRows(cis, dvs, win);
      renderTable(document.getElementById("tblRecon"),
        [{key:"patient",label:"Patient #"}, {key:"ci",label:"Check‑In Time"}, {key:"dv",label:"Seen Time"}, {key:"doctor",label:"Doctor"}, {key:"diffMin",label:"Δ minutes"}, {key:"status",label:"Status"}], rows);
      document.getElementById("cntUnmatched").textContent = unmatched.length;
      document.getElementById("cntUnseen").textContent = unseen.length;
      renderTable(document.getElementById("tblUnmatched"), [{key:"patient",label:"Patient #"}, {key:"dv",label:"Seen Time"}, {key:"doctor",label:"Doctor"}], unmatched);
      renderTable(document.getElementById("tblUnseen"), [{key:"patient",label:"Patient #"}, {key:"ci",label:"Check‑In Time"}], unseen);
    }

    // --- Audit Log renderer ---
    async function renderLog() {
      if (window.APP_ROLE !== "admin") return;
      const { data, error } = await supabase
        .from("audit_log")
        .select("id, ts, action, meta")
        .order("ts", { ascending: false })
        .limit(200);
      if (error) { alert("DB error: " + error.message); return; }

      const rows = (data || []).map(r => ({
        action: r.action,
        meta: (() => {
          try { return JSON.stringify(r.meta ?? {}, null, 0); }
          catch { return String(r.meta ?? ""); }
        })(),
        ts: r.ts
      }));

      renderTable(document.getElementById("tblLog"), [
        { key: "action", label: "Action" },
        { key: "meta", label: "Details" },
        { key: "ts", label: "Time" },
      ], rows);
    }

    async function addCheckIn(pn) {
      if (window.APP_ROLE !== "frontdesk" && window.APP_ROLE !== "admin") return alert("Front desk or admin only");
      const rec = await dbInsert("check_ins", { patient: pn });
      if (rec) { await dbLog("checkin:add", { patient: pn, ts: rec.ts }); renderRecent(); }
    }
    async function addDoctorVisit(pn, doctor) {
      if (window.APP_ROLE !== "doctor" && window.APP_ROLE !== "admin") return alert("Doctor or admin only");
      if (!doctor) { alert("Enter your doctor name or ID before submitting"); return; }
      const rec = await dbInsert("doctor_visits", { patient: pn, doctor });
      if (rec) { await dbLog("doctor:add", { patient: pn, doctor: rec.doctor, ts: rec.ts }); renderRecent(); }
    }
    async function exportJSON() {
      if (window.APP_ROLE !== "admin") return alert("Admin only");
      const since = new Date(); since.setDate(since.getDate() - 90);
      const { data: ci } = await supabase.from("check_ins").select("*").gte("ts", since.toISOString()).order("ts");
      const { data: dv } = await supabase.from("doctor_visits").select("*").gte("ts", since.toISOString()).order("ts");
      const { data: lg } = await supabase.from("audit_log").select("*").gte("ts", since.toISOString()).order("ts");
      const payload = { exported_at: new Date().toISOString(), check_ins: ci || [], doctor_visits: dv || [], audit_log: lg || [] };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
      const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "santana_checkin_export.json"; a.click();
    }
    function importJSONFile(file) {
      if (window.APP_ROLE !== "admin") return alert("Admin only");
      const reader = new FileReader();
      reader.onload = async e => {
        try {
          const data = JSON.parse(e.target.result);
          if (!Array.isArray(data.check_ins) || !Array.isArray(data.doctor_visits)) throw new Error("Invalid file");
          for (const row of data.check_ins) { await dbInsert("check_ins", row); }
          for (const row of data.doctor_visits) { await dbInsert("doctor_visits", row); }
          if (Array.isArray(data.audit_log)) { for (const row of data.audit_log) { await dbInsert("audit_log", row); } }
          alert("Import complete"); renderRecent();
        } catch (err) { alert("Import failed: " + err.message); }
      };
      reader.readAsText(file);
    }
    async function wipeAll() {
      if (window.APP_ROLE !== "admin") return alert("Admin only");
      if (!confirm("This will delete ALL records. Continue?")) return;
      await supabase.from("check_ins").delete().neq("id","00000000-0000-0000-0000-000000000000");
      await supabase.from("doctor_visits").delete().neq("id","00000000-0000-0000-0000-000000000000");
      await supabase.from("audit_log").delete().neq("id","00000000-0000-0000-0000-000000000000");
      await dbLog("admin:wipe",{}); renderRecent();
    }

    async function fetchAllUsers() {
      const { data, error } = await supabase.from("users").select("id,email,role,created_at").order("email");
      if (error) { alert("DB error: " + error.message); return []; }
      return data || [];
    }
    async function updateUserRoleById(id, role) {
      const { error } = await supabase.from("users").update({ role }).eq("id", id);
      if (error) { alert("DB error: " + error.message); return false; }
      await dbLog("role:update", { id, role });
      return true;
    }
    function userRowControls(row) {
      const wrap = document.createElement("div");
      wrap.className = "row";

      const sel = document.createElement("select");
      ["frontdesk","doctor","admin"].forEach(r => {
        const opt = document.createElement("option");
        opt.value = r; opt.textContent = r; if (row.role === r) opt.selected = true;
        sel.appendChild(opt);
      });

      const btn = document.createElement("button");
      btn.className = "btn"; btn.textContent = "Save";
      btn.onclick = async () => {
        const ok = await updateUserRoleById(row.id, sel.value);
        if (ok) { btn.textContent = "Saved"; setTimeout(()=>btn.textContent="Save", 1200); }
      };

      wrap.appendChild(sel); wrap.appendChild(btn);
      return wrap;
    }
    async function renderUsersList() {
      if (window.APP_ROLE !== "admin") return;
      const rows = await fetchAllUsers();
      const q = (document.getElementById("userSearch").value || "").toLowerCase().trim();
      const filtered = q ? rows.filter(r => (r.email||"").toLowerCase().includes(q)) : rows;
      document.getElementById("userCount").textContent = `${filtered.length} user${filtered.length===1?"":"s"}`;
      renderTable(document.getElementById("tblUsers"), [
        { key:"email", label:"Email" },
        { key:"role", label:"Role", render: userRowControls },
        { key:"created_at", label:"Created" },
      ], filtered);
    }

    const overlay = document.getElementById("authOverlay");
    function clearAuthFields() {
      const e = document.getElementById("authEmail");
      const p = document.getElementById("authPassword");
      if (e) e.value = "";
      if (p) p.value = "";
    }
    function openAuth(){ clearAuthFields(); overlay.style.display = "flex"; }
    function closeAuth(){ overlay.style.display = "none"; clearAuthFields(); }

    async function fetchRole() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return { user: null, role: null };
      const { data, error } = await supabase.from("users").select("role,email,display_name").eq("id", user.id).maybeSingle();
      if (error) { console.warn(error); return { user, role: null }; }
      return { user, role: data?.role || null, profile: data };
    }

    async function afterAuth() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        document.getElementById("userBadge").textContent = "Not signed in";
        document.getElementById("btnSignOut").style.display = "none";
        document.getElementById("tabs").innerHTML = "";
        openAuth();
        return;
      }
      const { data: existing } = await supabase.from("users").select("*").eq("id", user.id).maybeSingle();
      if (!existing) {
        const { count } = await supabase.from("users").select("id", { count: "exact", head: true });
        const role = (count === 0) ? "admin" : "frontdesk";
        await supabase.from("users").insert({ id: user.id, email: user.email, role });
      }
      const info = await fetchRole();
      window.APP_ROLE = info.role || "frontdesk";
      document.getElementById("userBadge").textContent = `${user.email} — ${window.APP_ROLE}`;
      document.getElementById("btnSignOut").style.display = "inline-block";
      showView("view-checkin", window.APP_ROLE);
      await renderRecent();
      const d = document.getElementById("reconDate"); if (d) d.value = new Date().toISOString().slice(0,10);
      closeAuth();
      resetInactivityTimer(); // start inactivity timer when authenticated
    }

    document.addEventListener("DOMContentLoaded", async () => {
      try { await waitForSupabase(); createClient(); }
      catch(e){ alert("Could not load Supabase library. Check your internet connection and reopen this file in Chrome."); console.error(e); return; }

      document.getElementById("btnOpenAuth").onclick = openAuth;
      document.getElementById("btnCloseAuth").onclick = closeAuth;
      document.getElementById("btnDoSignIn").onclick = async (e) => {
        e.preventDefault();
        const email = document.getElementById("authEmail").value.trim();
        const password = document.getElementById("authPassword").value;
        const { error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) { alert(error.message); return; }
        afterAuth();
      };
      document.getElementById("btnDoSignUp").onclick = async () => {
        const email = document.getElementById("authEmail").value.trim();
        const password = document.getElementById("authPassword").value;
        const { error } = await supabase.auth.signUp({ email, password });
        if (error) { alert(error.message); return; }
        alert("Signed up. Now click Sign in.");
      };
      document.getElementById("btnForgot").onclick = async () => {
  const email = document.getElementById("authEmail").value.trim();
  if (!email) return alert("Enter your email address first.");
  const { error } = await supabase.auth.resetPasswordForEmail(email, {
    redirectTo: window.location.href // user returns here after reset
  });
  if (error) return alert(error.message);
  alert("Password reset email sent. Check your inbox.");
};
      document.getElementById("btnSignOut").onclick = async () => {
        await supabase.auth.signOut();
        window.APP_ROLE = null;
        clearAuthFields();
        openAuth();
      };

      document.getElementById("btnAddCheckin").onclick = () => {
        const pn = document.getElementById("ciPatient").value.trim();
        if (!pn) return alert("Enter patient number");
        addCheckIn(pn); document.getElementById("ciPatient").value = "";
      };
      document.getElementById("btnAddDoctorVisit").onclick = () => {
        const pn = document.getElementById("dvPatient").value.trim();
        const dr = document.getElementById("dvDoctor").value.trim();
        if (!pn) return alert("Enter patient number");
        if (!dr) return alert("Enter your doctor name or ID before submitting");
        addDoctorVisit(pn, dr); document.getElementById("dvPatient").value = ""; document.getElementById("dvDoctor").value = "";
      };

      document.getElementById("btnRefreshRecon").onclick = renderRecon;
      document.getElementById("reconDate").addEventListener("change", renderRecon);
      document.getElementById("windowHrs").addEventListener("change", renderRecon);
      document.getElementById("btnExportCSV").onclick = async () => {
        const date = document.getElementById("reconDate").value ? new Date(document.getElementById("reconDate").value + "T00:00:00") : new Date();
        const cis = await dbByDay("check_ins", date);
        const dvs = await dbByDay("doctor_visits", date);
        const { rows } = reconcileRows(cis, dvs, parseInt(document.getElementById("windowHrs").value || "24", 10));
        const headers = ["patient_number","checkin_timestamp","seen_timestamp","doctor","diff_minutes","status"];
        const csv = [headers.join(",")].concat(rows.map(r => [r.patient,r.ci,r.dv,r.doctor||"",r.diffMin||"",r.status].map(v => `"${String(v??"").replace(/"/g,'""')}"`).join(","))).join("\n");
        const blob = new Blob([csv], { type: "text/csv" });
        const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "reconciliation.csv"; a.click();
      };

      document.getElementById("btnExport").onclick = exportJSON;
      document.getElementById("btnImport").onclick = () => document.getElementById("fileImport").click();
      document.getElementById("fileImport").addEventListener("change", (e) => { if (e.target.files && e.target.files[0]) importJSONFile(e.target.files[0]); });
      document.getElementById("btnWipe").onclick = wipeAll;

      document.getElementById("btnRefreshUsers").onclick = renderUsersList;
      document.getElementById("userSearch").addEventListener("input", renderUsersList);

      const { data: { session } } = await supabase.auth.getSession();
      if (!session) { openAuth(); } else { afterAuth(); }
      supabase.auth.onAuthStateChange((_event, _session) => { afterAuth(); });
    });
  </script>
</body>
</html>
